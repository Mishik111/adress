<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Chat Debugger</title>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; display: flex; justify-content: center; padding: 20px; }
        #chat { width: 400px; height: 500px; background: white; border-radius: 8px; display: flex; flex-direction: column; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        #messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 10px; border-radius: 10px; max-width: 80%; font-size: 14px; position: relative; }
        .sent { align-self: flex-end; background: #dcf8c6; border-bottom-right-radius: 2px; }
        .received { align-self: flex-start; background: #fff; border: 1px solid #ddd; border-bottom-left-radius: 2px; }
        .sender { font-size: 9px; color: #999; display: block; margin-bottom: 4px; }
        .error { color: red; font-size: 12px; padding: 10px; }
    </style>
</head>
<body>

<div id="chat">
    <div id="messages">Загрузка данных...</div>
</div>

<script>
    async function loadChat() {
        const msgContainer = document.getElementById('messages');
        // Прокси используем ТОЛЬКО для проблемного сервера devtunnels
        const proxy = "https://corsproxy.io?"; 

        try {
            // 1. GitHub тянем НАПРЯМУЮ (он поддерживает CORS)
            const urlResponse = await fetch("https://raw.githubusercontent.com");
            let baseUrl = (await urlResponse.text()).trim();
            
            // 2. Строим путь
            const finalUrl = baseUrl.endsWith('/') ? baseUrl + "get_messages" : baseUrl + "/get_messages";
            
            // 3. А вот сервер devtunnels тянем ЧЕРЕЗ прокси
            console.log("Запрос к:", finalUrl);
            const contentResponse = await fetch(proxy + encodeURIComponent(finalUrl));
            
            if (!contentResponse.ok) throw new Error("Сервер не ответил");
            const messages = await contentResponse.json();

            // 4. Отрисовка
            msgContainer.innerHTML = ''; 
            messages.forEach(msg => {
                const div = document.createElement('div');
                const isMe = String(msg.from) === "7";
                div.className = `msg ${isMe ? 'sent' : 'received'}`;
                div.innerHTML = `<span class="sender">ID: ${msg.from}</span>${msg.content}`;
                msgContainer.appendChild(div);
            });
            msgContainer.scrollTop = msgContainer.scrollHeight;

        } catch (error) {
            msgContainer.innerHTML = `<div class="error">
                <b>Ошибка:</b> ${error.message}<br><br>
                1. Проверь, запущен ли сервер в Dev Tunnel.<br>
                2. Открой ссылку из 1.txt в браузере и нажми "Continue".
            </div>`;
        }
    }

    loadChat();
    // Обновляем раз в 5 секунд
    setInterval(loadChat, 5000);
</script>

</body>
</html>
